worker_processes auto;
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;
    resolver 127.0.0.11 valid=30s;
    resolver_timeout 5s;

    upstream auth_backend      {
        zone auth_backend 64k;
        server auth-service:8080 resolve;
    }
    upstream products_backend  {
        zone products_backend 64k;
        server product-service:8080 resolve;
    }
    upstream inventory_backend {
        zone inventory_backend 64k;
        server inventory-service:8080 resolve;
    }
    upstream orders_backend    {
        zone orders_backend 64k;
        server order-service:8080 resolve;
    }
    upstream payments_backend  {
        zone payments_backend 64k;
        server payment-service:8080 resolve;
    }
    upstream notification_backend {
        zone notification_backend 64k;
        server notification-service:8080 resolve;
    }
    upstream temporal_ui       {
        zone temporal_ui 64k;
        server temporal-ui:8080 resolve;
    }
    upstream swagger_ui        {
        zone swagger_ui 64k;
        server swagger-ui:8080 resolve;
    }
    upstream frontend_app      {
        zone frontend 64k;
        server frontend:80 resolve;
    }

    server {
        listen 80;

        # Basic Auth for Temporal UI
        auth_basic_user_file /etc/nginx/.htpasswd;

        # API Routes
        location ^~ /api/notifications {
            rewrite ^/api/notifications(.*)$ /notifications$1 break;
            proxy_pass http://notification_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # SSE configuration
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
            proxy_read_timeout 3600s;
        }

        location ^~ /api/auth {
            rewrite ^/api/auth(.*)$ /auth$1 break;
            proxy_pass http://auth_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ^~ /api/products {
            rewrite ^/api/products(.*)$ /products$1 break;
            proxy_pass http://products_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ^~ /api/inventory {
            rewrite ^/api/inventory(.*)$ /inventory$1 break;
            proxy_pass http://inventory_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ^~ /api/orders {
            rewrite ^/api/orders(.*)$ /orders$1 break;
            proxy_pass http://orders_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ^~ /api/payments {
            rewrite ^/api/payments(.*)$ /payments$1 break;
            proxy_pass http://payments_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Admin routes - proxy to auth service
        location ^~ /api/admin {
            rewrite ^/api/admin(.*)$ /admin$1 break;
            proxy_pass http://auth_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location ^~ /temporal {
            auth_basic "Restricted Area";
            # rewrite ^/temporal-ui(.*)$ /temporal$1 break;
            proxy_pass http://temporal_ui;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Frontend - All other requests go to React app
        location / {
            proxy_pass http://frontend_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }


        # Swagger UI (trailing slash strips /swagger prefix)
        location ^~ /swagger/ {
            proxy_pass http://swagger_ui/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # API Docs Proxies
        location /docs/auth {
            proxy_pass http://auth_backend/v3/api-docs;
            proxy_set_header Host $host;
        }

        location /docs/products {
            proxy_pass http://products_backend/v3/api-docs;
            proxy_set_header Host $host;
        }

        location /docs/inventory {
            proxy_pass http://inventory_backend/v3/api-docs;
            proxy_set_header Host $host;
        }

        location /docs/orders {
            proxy_pass http://orders_backend/v3/api-docs;
            proxy_set_header Host $host;
        }

        location /docs/payments {
            proxy_pass http://payments_backend/v3/api-docs;
            proxy_set_header Host $host;
        }

        location /docs/notifications {
            proxy_pass http://notification_backend/v3/api-docs;
            proxy_set_header Host $host;
        }
    }
}
